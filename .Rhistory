})
})
return(output)
}
rownames(trawlbyspecimen) = cast_broadiets$Specimen
rownames(cast_broadiets) = cast_broadiets$Specimen
rel_trawls <- t(apply(trawlbyspecimen[,c(-1,-4,-18)],1,function(x){x <- x/sum(x, na.rm = T); return(x)}))  #-4 -18 to get rid of "Animal" and "Egg" concepts
colnames(rel_trawls)[which(!(colnames(rel_trawls) %in% colnames(cast_broadiets)))] #CHECK EVERY TIME!
expanded_broadiets <- data.frame(cast_broadiets, Amphipod = rep(0, nrow(cast_broadiets)),Anthozoa = rep(0, nrow(cast_broadiets)),Barnacle = rep(0, nrow(cast_broadiets)),Brachiopod = rep(0, nrow(cast_broadiets)),Cephalopod = rep(0, nrow(cast_broadiets)),Chaetognath = rep(0, nrow(cast_broadiets)),Cladoceran = rep(0, nrow(cast_broadiets)),Cumacean = rep(0, nrow(cast_broadiets)),Doliolid = rep(0, nrow(cast_broadiets)),Echinoderm = rep(0, nrow(cast_broadiets)), Gastropod = rep(0, nrow(cast_broadiets)), Pyrosome = rep(0, nrow(cast_broadiets)),Siphonophore = rep(0, nrow(cast_broadiets)), Hydromedusa = rep(0, nrow(cast_broadiets)), Isopod = rep(0, nrow(cast_broadiets)), Polychaete = rep(0, nrow(cast_broadiets)), Phyllocarid = rep(0, nrow(cast_broadiets)))
expanded_broadiets <- expanded_broadiets[,match(colnames(rel_trawls), colnames(expanded_broadiets))]
rel_GC <- t(apply(expanded_broadiets,1,function(x){x <- x/sum(x); return(x)}))
selectivity <- as.data.frame(matrix(nrow=nrow(rel_trawls), ncol=ncol(rel_trawls)))
names(selectivity) <- colnames(rel_trawls); rownames(selectivity) <- rownames(rel_GC)
selectivity <- LI(rel_GC, rel_trawls,selectivity)
cast_broadiets$Species[which(cast_broadiets$Species=="Apolemia undescribed sp")] <- "Apolemia sp"
cast_broadiets$Species[which(cast_broadiets$Species=="Nanomia (deep)")] <- "Nanomia sp. deep"
selectivity <- data.frame(selectivity, Species = cast_broadiets$Species, Specimen = cast_broadiets$Specimen)
selectivity_melt <- melt(selectivity, id.vars = c("Specimen", "Species"))
names(selectivity_melt) <- c("Specimen","Species", "Prey", "L.I.")
selectivity_melt$Species <- as.character(selectivity_melt$Species)
selectivity_melt$Species <- factor(selectivity_melt$Species, levels=SPorder[which(SPorder %in% selectivity_melt$Species)])
IDorder <- unique(arrange(selectivity_melt, Species)$Specimen)
selectivity_melt$Specimen <- factor(selectivity_melt$Specimen, levels=IDorder)
selectivity_melt$Prey <- factor(selectivity_melt$Prey, levels=PreyOrderTr)
names(selectivity_melt)[3]<-"Selectivity"
selectivity_melt[,4] <- as.numeric(selectivity_melt[,4])
SEL <- ggplot(selectivity_melt, aes(x = Selectivity, y = Specimen, fill = `L.I.`)) + geom_tile() + scale_fill_gradient2(low = "red", high = "blue", mid = "white", na.value = "grey") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.title.y=element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank())
selectivity_spp <- aggregate(selectivity_melt$L.I.~selectivity_melt$Selectivity+selectivity_melt$Species, FUN=function(x){mean(x,na.rm = T)})
names(selectivity_spp) <- c("Prey","Species","L.I.")
GCspecies_melt$Species[which(!(GCspecies_melt$Species %in% selectivity_spp$Species))] %>% unique() -> missing_spp
expand.grid(unique(selectivity_spp$Prey),missing_spp)->missing_entries
missing_entries <- cbind(missing_entries, rep(NA, nrow(missing_entries)))
names(missing_entries) <- names(selectivity_spp)
selectivity_spp <- rbind(selectivity_spp, missing_entries)
#Specimen tree
data.frame(GC_Trawl_broad$Species,GC_Trawl_broad$Specimen) %>% arrange(GC_Trawl_broad.Species)
ind_tree = read.newick(text="((P1,P2,P3),(((D10,SS4,D2),(D1,D2),(D1,D6)),(((SS12,D12),SS6,(SS7,D9)),(((D5,(D6,SS8)),(D8,((D9,D9),(SS11,(D8,((36,38,24,26,28,30,34),(40.1,BW7-4),(SS8,SS10))))))),((D8,SS10),(SS12,(SS9,(((35.2,BW60),D6),((BW65,(SS12,2_4)),(39,BW25,BW1,BW24))))))))))));")
lit <- read.csv("siphweb_metabarcoding/Literature-data/allinteractions.tsv", sep="\t", stringsAsFactors = F)
ROV_lit <- lit[which(lit$source %in% c("Pugh2009cResomiidae", "Choy_2017", "Hissman2005_newrho")),]
ROV_lit$Predator[which(ROV_lit$Predator=="Apolemia")] <- "Apolemia sp"
ROV_lit$Predator[which(ROV_lit$Predator=="Bargmannia")] <- "Bargmannia elongata" #according to Steve June 02, 4.39PM
ROV_lit$Predator[which(ROV_lit$Predator=="Forskalia")] <- "Forskalia sp."
ROV_lit$Predator[which(ROV_lit$Predator=="Nanomia bijuga")] <- "Nanomia sp. deep"
ROV_pruned <- ROV_lit[which(ROV_lit$Predator %in% unique(meltedGC$Species)),]
ROV_pruned$Predator <- factor(ROV_pruned$Predator, levels=SPorder)
ggplot(ROV_pruned, aes(x = Prey_broad, y = Predator, fill = log(Num_interactions))) + geom_tile() + scale_fill_gradient(low = "white", high = "black") + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.title.y=element_blank())
GC_lit <- lit[which(!(lit$source %in% c("Pugh2009cResomiidae", "Choy_2017", "Hissman2005_newrho"))),]
GC_lit$Predator[which(GC_lit$Predator=="Nanomia bijuga" & GC_lit$source=="Biggs1977b_Feeding")] <- "Nanomia sp. Atlantic"
GC_lit$Prey_broad[which(GC_lit$Predator=="Nanomia sp. Atlantic" & GC_lit$source=="Biggs1977b_Feeding")] <- "Mysid"
GC_lit$Predator[which(GC_lit$Predator=="Nanomia bijuga" & GC_lit$source=="Purcell1981b_feeding")] <- "Nanomia sp. shallow"
GC_lit$Predator[which(GC_lit$Predator=="Apolemia uvaria")] <- "Apolemia sp" #questionable choice...
GC_lit$Predator[which(GC_lit$Predator=="Forskalia edwardsi")] <- "Forskalia sp."
GC_lit$Predator[which(GC_lit$Predator=="Forskalia tholoides")] <- "Forskalia sp."
GC_lit <- GC_lit[which(GC_lit$Prey != "Crustacea"),]
GC_pruned <- GC_lit[which(GC_lit$Predator %in% unique(meltedGC$Species)),]
ggplot(GC_pruned, aes(x = Prey_broad, y = Predator, fill = Num_interactions)) + geom_tile(color="grey") + scale_fill_gradient(low = "black", high = "black") + theme_bw() + theme(panel.grid.major = element_blank()) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.title.y=element_blank())
MorphDAPC <- read.csv("siphweb_metabarcoding/Literature-data/DAPCdiet_posteriors.tsv", sep="\t", stringsAsFactors = F)
#MorphDAPC <- MorphDAPC[which(MorphDAPC$Species %in% unique(meltedGC$Species)),]
meltedMorph <- melt(MorphDAPC)
names(meltedMorph)[2:3] <- c("Prey","Predicted")
meltedMorph$Species[which(meltedMorph$Species=="Physonect sp")] <- "Undescribed physonect L"
meltedMorph$Species[which(meltedMorph$Species=="Forskalia formosa")] <- "Forskalia sp."
meltedMorph$Species[which(meltedMorph$Species=="Forskalia asymmetrica")] <- "Forskalia sp."
meltedMorph$Species[which(meltedMorph$Species=="Forskalia edwardsii")] <- "Forskalia sp."
ggplot(meltedMorph, aes(x = Prey, y = Species, fill = Predicted)) + geom_tile() + scale_fill_gradient(low = "white", high = "black")+ theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.title.y=element_blank())
morph <- rbind(mutate(meltedMorph[which(meltedMorph$Prey == "Large.crustacean"),], Prey_extrapolate="Decapod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Large.crustacean"),], Prey_extrapolate="Euphausid"),
mutate(meltedMorph[which(meltedMorph$Prey == "Large.crustacean"),], Prey_extrapolate="Mysid"),
mutate(meltedMorph[which(meltedMorph$Prey == "Large.crustacean"),], Prey_extrapolate="Lophogastrid"),
mutate(meltedMorph[which(meltedMorph$Prey == "Large.crustacean"),], Prey_extrapolate="Stomatopod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Large.crustacean"),], Prey_extrapolate="Amphipod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Small.crustacean"),], Prey_extrapolate="Copepod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Small.crustacean"),], Prey_extrapolate="Cladoceran"),
mutate(meltedMorph[which(meltedMorph$Prey == "Small.crustacean"),], Prey_extrapolate="Ostracod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Fish"),], Prey_extrapolate="Actinopteri"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Actinopteri"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Decapod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Euphausid"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Mysid"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Lophogastrid"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Stomatopod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Amphipod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Copepod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Cladoceran"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Ostracod"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Mollusc"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Polychaete"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Chaetognath"),
mutate(meltedMorph[which(meltedMorph$Prey == "Mixed"),], Prey_extrapolate="Larvacean"),
mutate(meltedMorph[which(meltedMorph$Prey == "Gelatinous"),], Prey_extrapolate="Gelatinous")
)
morph <- cbind(morph[,c(1,4,3)],rep("Morphology",nrow(morph)))
names(morph) <- c("Species","Prey","N","Source")
metabar <- cbind(GCspecies_melt, rep("Metabarcoding",nrow(GCspecies_melt)))
names(metabar) <- c("Species","Prey","N","Source")
lit_deep <- cbind(ROV_pruned[,c(1,4,6)], rep("Literature_Deep",nrow(ROV_pruned)))
names(lit_deep) <- c("Species","Prey","N","Source")
lit_shallow <- cbind(GC_pruned[,c(1,4,6)], rep("Literature_Shallow",nrow(GC_pruned)))
names(lit_shallow) <- c("Species","Prey","N","Source")
sources_combo <- rbind(metabar, lit_deep, lit_shallow)
sources_combo$Prey[which(sources_combo$Prey == "Fish")]<-"Actinopteri"
sources_combo$Prey[which(sources_combo$Prey == "Euphausiid")]<-"Euphausid"
#sources_combo$N[which(sources_combo$N == 0)]<-NA
sources_combo=sources_combo[which(sources_combo$Prey != "Crustacea"),]
sources_combo$Prey[which(sources_combo$Prey == "Salp")]<-"Gelatinous"
sources_combo$Prey[which(sources_combo$Prey == "Hydrozoa")]<-"Gelatinous"
sources_combo$Prey[which(sources_combo$Prey == "Medusae")]<-"Gelatinous"
sources_combo$Prey[which(sources_combo$Prey == "Scyphomedusa")]<-"Gelatinous"
sources_combo$Prey[which(sources_combo$Prey == "Scyphozoa")]<-"Gelatinous"
sources_combo$Prey[which(sources_combo$Prey == "Ctenophore")]<-"Gelatinous"
sources_combo$Prey[which(sources_combo$Prey == "Bivalve")]<-"Mollusc"
sources_combo$Prey[which(sources_combo$Prey == "Gastropod")]<-"Mollusc"
sources_combo$Prey[which(sources_combo$Prey == "Cephalopod")]<-"Mollusc"
sources_combo$N[which(sources_combo$N != 0)]<-1
PreyOrderComb <- c("Copepod","Decapod","Euphausid","Mysid","Lophogastrid","Stomatopod","Amphipod","Cladoceran","Ostracod","Mollusc","Polychaete","Chaetognath","Gelatinous","Larvacean","Actinopteri")
sources_combo$Prey <- factor(sources_combo$Prey,levels=PreyOrderComb)
sources_combo_nulls_M <- sources_combo
sources_combo_nulls_M$N <- 0
sources_combo_nulls_M$Source <- "Metabarcoding"
sources_combo_nulls_D <- sources_combo_nulls_M
sources_combo_nulls_D$Source <- "Literature_Deep"
sources_combo_nulls_S <- sources_combo_nulls_D
sources_combo_nulls_S$Source <- "Literature_Shallow"
sources_combo <- rbind(sources_combo,sources_combo_nulls_M,sources_combo_nulls_D,sources_combo_nulls_S)
#sources_combo <- unique(sources_combo)
morph <- morph[which(morph$Species %in% sources_combo$Species),]
#Supplementary compoplots
ref_samples <- allsamples[which(!(allsamples$Interpretation %in% c("Short","Unknown"))),]
ref_samples$Interpretation[which(ref_samples$Interpretation == "Cross")] <- "Contamination"
dim(ref_samples[which(ref_samples$Broad.group != "Siphonophore"),])
dim(ref_samples)
#############
#Without siph signal
nosiph_samples <- ref_samples[which(ref_samples$Broad.group != "Siphonophore"),]
ggplot(nosiph_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(8, "Set2"))(16), colorRampPalette(brewer.pal(8, "Set1"))(16), colorRampPalette(brewer.pal(8, "Dark2"))(23))) + guides(shape = guide_legend(override.aes = list(size = 1)))
#############
#Without siph signal
nosiph_samples <- ref_samples[which(ref_samples$Broad.group != "Siphonophore" & ref_samples$Broad.group != "Eukaryote"),]
ggplot(nosiph_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(8, "Set2"))(16), colorRampPalette(brewer.pal(8, "Set1"))(16), colorRampPalette(brewer.pal(8, "Dark2"))(23))) + guides(shape = guide_legend(override.aes = list(size = 1)))
#############
#Without siph signal
nosiph_samples <- ref_samples[which(ref_samples$Interpretation == "Prey"),]
ggplot(nosiph_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(8, "Set2"))(16), colorRampPalette(brewer.pal(8, "Set1"))(16), colorRampPalette(brewer.pal(8, "Dark2"))(23))) + guides(shape = guide_legend(override.aes = list(size = 1)))
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(8, "Dark2"))(23))) + guides(shape = guide_legend(override.aes = list(size = 1)))
#############
#Without siph signal
prey_samples <- ref_samples[which(ref_samples$Interpretation == "Prey"),]
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(8, "Dark2"))(23))) + guides(shape = guide_legend(override.aes = list(size = 1)))
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(8, "Dark2"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(8, "Set2"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(8, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1))) +  facet_grid(.~barcode)
ggplot(prey_samples, aes(x = paste(Species, Specimen), y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))
ggplot(prey_samples, aes(x = paste(Species, Specimen), y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))  + facet_wrap(.~barcode, nrow=6, ncol=1)
pdf("SM_spp_broadgroup_prey.pdf", width = 20, height = 10)
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))
dev.off()
#species by broad group and barcode
pdf("SM_spp_broadgroup_barcode_prey.pdf", width = 20, height = 10)
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1))) +  facet_grid(.~barcode)
dev.off()
#specimens by broad group
pdf("SM_ind_broadgroup_prey.pdf", width = 20, height = 10)
ggplot(prey_samples, aes(x = paste(Species, Specimen), y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))
dev.off()
#specimens by broad group and barcode
pdf("SM_ind_broadgroup_barcode_prey.pdf", width = 20, height = 30)
ggplot(prey_samples, aes(x = paste(Species, Specimen), y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))  + facet_wrap(.~barcode, nrow=6, ncol=1)
dev.off()
pdf("SM_spp_broadgroup_barcode_prey.pdf", width = 20, height = 6)
ggplot(prey_samples, aes(x = Species, y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1))) +  facet_grid(.~barcode)
dev.off()
pdf("SM_ind_broadgroup_barcode_prey.pdf", width = 20, height = 6)
ggplot(prey_samples, aes(x = paste(Species, Specimen), y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))  + facet_wrap(.~barcode, nrow=6, ncol=1)
dev.off()
pdf("SM_ind_broadgroup_barcode_prey.pdf", width = 20, height = 10)
ggplot(prey_samples, aes(x = paste(Species, Specimen), y = log(abundance), fill = Broad.group)) + geom_bar(position = "fill",stat = "identity") + theme_bw() + theme(legend.key.size = unit(1,"line"), legend.text = element_text(size=5),legend.position="bottom", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c(colorRampPalette(brewer.pal(6, "Set1"))(14))) + guides(shape = guide_legend(override.aes = list(size = 1)))  + facet_wrap(.~barcode, nrow=6, ncol=1)
dev.off()
rel_trawls
as.data.frame(rel_trawls)$Actinopteri
as.data.frame(rel_trawls)$Actinopteri[is.na(as.data.frame(rel_trawls)$Actinopteri)]
as.data.frame(rel_trawls)$Actinopteri[is.na(as.data.frame(rel_trawls)$Actinopteri)] %>% length()
as.data.frame(rel_trawls)$Actinopteri[!is.na(as.data.frame(rel_trawls)$Actinopteri)] %>% length()
trawlbyspecimen
GC_Trawl_broad
cast_trawl
cast_trawl[1:5,] %>% plot
cast_trawl[2:5,] %>% plot
cast_trawl[2,] %>% histogram()
cast_trawl[2,] %>% hist()
cast_trawl[2,] %>% plot
cast_trawl[2,]
cast_trawl[2,] %>% sort()
cast_trawl[2,-1] %>% sort()
cast_trawl[3,-1] %>% sort()
cast_trawl[3,] %>% sort()
cast_trawl[3,-1] %>% sort()
cast_trawl[4,-1] %>% sort()
cast_trawl[5,-1] %>% sort()
cast_trawl$Sample
cast_trawl[17,-1] %>% sort()
cast_trawl[18,-1] %>% sort()
trawl_to_specimen$Corresponding.prey.field.sample
cast_trawl[18,-1] %>% sort()
cast_trawl[17,-1] %>% sort()
trawl_to_specimen$Corresponding.prey.field.sample %>% View()
trawl_to_specimen %>% View()
trawl_to_specimen %>% unique() %>% View()
cast_trawl[,1] %>% sort()
cast_trawl[15,-1] %>% sort()
cast_trawl[11,-1] %>% sort()
trawl_to_specimen %>% unique() .[,3] %>% unique()
trawl_to_specimen %>% unique() %>%  .[,3] %>% unique()
cast_trawl[,1] %>% sort()
cast_trawl[11,-1] %>% sort()
cast_trawl[13,-1] %>% sort()
cast_trawl[14,-1] %>% sort()
cast_trawl[15,-1] %>% sort()
cast_trawl[16,-1] %>% sort()
cast_trawl[11,-1]
cast_trawl[13,-1]
cast_trawl[5-10,-1]
cast_trawl[6-10,-1]
cast_trawl[6:10,-1]
cast_trawl[6:10,-1] %>% colSums()
cast_trawl[6:10,-1] %>% colSums()Msort()
cast_trawl[6:10,-1] %>% colSums() %>% sort()
trawl_to_specimen %>% unique() %>%  .[,3] %>% unique()
trawl_to_specimen %>% unique()
trawl_to_specimen %>% unique() %>%  .[,3] %>% unique()
trawl_to_specimen %>% unique() %>%  .[,3] %>% unique()Msort()
trawl_to_specimen %>% unique() %>%  .[,3] %>% unique() %>% sort()
ext <- read.csv("/Volumes/GoogleDrive/My Drive/Metabarcoding_things/siphweb_metabarcoding/extractions_GC_Nov2020.tsv", header=T, stringsAsFactors = F, sep="\t" )
trawl_to_specimen <- ext[,c(1,3,13)]
RUN0trawls = data.frame(Extraction..=allsamples$Extraction, Specimen.. = allsamples$Specimen, Corrresponding.prey.field.sample = rep(NA, nrow(allsamples)))[which(allsamples$run == "RUN0"),]
names(RUN0trawls) <- names(trawl_to_specimen)
trawl_to_specimen <- rbind(trawl_to_specimen, RUN0trawls)
dyads_by_specimen = list()
it=0
for(i in unique(allsamples$Specimen)){
dyad_i = list()
dyad_i[[1]] <- allsamples[which(allsamples$Specimen == i),]
tows <- trawl_to_specimen$Corresponding.prey.field.sample[which(trawl_to_specimen$Specimen.. == i)]
trawls_i <- trawls[which(trawls$Sample == tows),]
if(nrow(trawls_i)>0){dyad_i[[2]] <- trawls_i}
else dyad_i[[2]] <- NA
names(dyad_i)=c("Diet", "Preyfield")
it=it+1
dyads_by_specimen[[it]] <- dyad_i
names(dyads_by_specimen)[[it]] <- i
}
dyads_by_specimen$`BIOS19-D2-P1`$Preyfield[,c(2,3,4,7)]
dyads_by_specimen$`BIOS19-D2-P1`$Diet[,c(8:11,48)]
diets_broad <- allsamples[which(allsamples$Interpretation == "Prey"),c("Specimen","Species","Broad.group")] %>% unique()
cast_broadiets <- dcast(diets_broad, Specimen + Species ~ Broad.group)
cast_broadiets[is.na(cast_broadiets)] <- 0
cast_broadiets[,c(3:ncol(cast_broadiets))] <- sapply(cast_broadiets[,c(3:ncol(cast_broadiets))], as.numeric)
cast_broadiets[is.na(cast_broadiets)] <- 1
#Widen format of trawl data
cast_trawl <- dcast(broad.taxa, Sample ~ Broad.group)
cast_trawl[is.na(cast_trawl)] <- 0
#Match trawlcast to specimen
trawlbyspecimen <- cast_trawl[match(trawl_to_specimen$Corresponding.prey.field.sample[match(cast_broadiets$Specimen, trawl_to_specimen$Specimen..)], cast_trawl$Sample),]
names(trawlbyspecimen)[1]<-"Trawl"
trawlbyspecimen <- data.frame(trawlbyspecimen, Phyllocarid = trawlbyspecimen$Stomatopod*0) #add phyllocarid zeroes
#Bind GC and trawls
GC_Trawl_broad <- cbind(cast_broadiets, trawlbyspecimen)
rownames(GC_Trawl_broad)<-GC_Trawl_broad$Specimen
GC_Trawl_broad$Species[which(GC_Trawl_broad$Species=="Apolemia undescribed sp")] <- "Apolemia sp"
GC_Trawl_broad$Species[which(GC_Trawl_broad$Species=="Nanomia (deep)")] <- "Nanomia sp. deep"
GC_Trawl_broad[,c("Cephalopod", "Cumacean")]
meltedGC = melt(GC_Trawl_broad[,1:16])
names(meltedGC)[3:4] <- c("Gut Content Prey", "Presence")
meltedGC$Species <- factor(meltedGC$Species, levels=SPorder)
IDorder <- unique(arrange(meltedGC, Species)$Specimen)
meltedGC$Specimen <- factor(meltedGC$Specimen, levels=IDorder)
PreyOrder <- c("Copepod", "Decapod", "Euphausid", "Mysid", "Lophogastrid","Stomatopod", "Amphipod", "Ostracod", "Bivalve", "Gastropod", "Larvacean", "Salp", "Scyphomedusa", "Ctenophore", "Actinopteri")
meltedGC$`Gut Content Prey` <- factor(meltedGC$`Gut Content Prey`, levels=PreyOrder)
GC <- ggplot(meltedGC, aes(x = `Gut Content Prey`, y = Specimen, fill = Presence)) + geom_tile(color="grey") +scale_fill_gradient(low = "white", high = "black") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") + ylab("Specimen")
GC
ggplot(meltedGC, aes(x = `Gut Content Prey`, y = Specimen, fill = Presence)) + geom_tile(color="grey") +scale_fill_gradient(low = "white", high = "black") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") + ylab("Specimen")
meltedGC
meltedGC %>% head()
ggplot(meltedGC, aes(x = `Gut Content Prey`, y = Specimen, fill = Presence)) + geom_tile(color="grey")
ggplot(meltedGC, aes(x = `Gut Content Prey`, y = Specimen, fill = Presence)) + geom_tile(color="grey") +scale_fill_gradient(low = "white", high = "black") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") + ylab("Specimen")
dev.off()
ggplot(meltedGC, aes(x = `Gut Content Prey`, y = Specimen, fill = Presence)) + geom_tile(color="grey") +scale_fill_gradient(low = "white", high = "black") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") + ylab("Specimen")
GC <- ggplot(meltedGC, aes(x = `Gut Content Prey`, y = Specimen, fill = Presence)) + geom_tile(color="grey") +scale_fill_gradient(low = "white", high = "black") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") + ylab("Specimen")
## by species
GCspecies <- aggregate(x = GC_Trawl_broad[,3:16], by = list(GC_Trawl_broad$Species), FUN = "sum")
names(GCspecies)[1] <- "Species"
GCspecies_melt = melt(GCspecies)
names(GCspecies_melt)[2:3] <- c("Gut Content Prey","N")
GCspecies_melt$Species <- factor(GCspecies_melt$Species, levels=SPorder)
GCspecies_melt$`Gut Content Prey` <- factor(GCspecies_melt$`Gut Content Prey`, levels=PreyOrder)
GC_spp <- ggplot(GCspecies_melt, aes(x = `Gut Content Prey`, y = Species, fill = log(N+1))) + geom_tile(color="grey") + scale_fill_gradient(low = "white", high = "black") + geom_text(aes(label=N), col="red") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + ylab("Species")
meltedTrawls = melt(GC_Trawl_broad[,c(1,2,17:ncol(GC_Trawl_broad))])
names(meltedTrawls)[4:5] <- c("Prey", "Abundance")
meltedTrawls <- ddply(meltedTrawls, .(Specimen), transform, Relative.Abundance = scale(log(Abundance+1)))
meltedTrawls <- meltedTrawls[which(!(meltedTrawls$Prey %in% c("Animal", "Egg"))),]
names(meltedTrawls)[4]<-"Ambient Prey"
PreyOrderTr <- c("Copepod", "Decapod", "Euphausid", "Mysid", "Lophogastrid", "Stomatopod",  "Ostracod", "Bivalve","Larvacean", "Salp",  "Scyphomedusa", "Ctenophore", "Actinopteri", "Cladoceran", "Amphipod", "Isopod", "Barnacle", "Cumacean", "Phyllocarid", "Brachiopod", "Echinoderm","Polychaete", "Chaetognath", "Gastropod", "Cephalopod", "Doliolid", "Pyrosome", "Hydromedusa", "Siphonophore", "Anthozoa")
meltedTrawls$`Ambient Prey` <- factor(meltedTrawls$`Ambient Prey`, levels=PreyOrderTr)
meltedTrawls$Species <- factor(meltedTrawls$Species, levels=SPorder)
IDorder <- unique(arrange(meltedTrawls, Species)$Specimen)
meltedTrawls$Specimen <- factor(meltedTrawls$Specimen, levels=IDorder)
TR <- ggplot(meltedTrawls, aes(x = `Ambient Prey`, y = Specimen, fill = Relative.Abundance)) + geom_tile() + scale_fill_gradient(low = "white", high = "dark blue", na.value = "grey") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.title.y=element_blank(),axis.text.y=element_blank(),legend.position = "none", axis.ticks = element_blank())
ggplot(meltedTrawls, aes(x = `Ambient Prey`, y = Specimen, fill = Relative.Abundance)) + geom_tile() + scale_fill_gradient(low = "white", high = "dark blue", na.value = "grey") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.title.y=element_blank(),axis.text.y=element_blank(),legend.position = "none", axis.ticks = element_blank())
ggplot(meltedTrawls, aes(x = `Ambient Prey`, y = Specimen, fill = Relative.Abundance)) + geom_tile() + scale_fill_gradient(low = "white", high = "dark blue", na.value = "grey") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
LI
rownames(trawlbyspecimen) = cast_broadiets$Specimen
rownames(cast_broadiets) = cast_broadiets$Specimen
rel_trawls <- t(apply(trawlbyspecimen[,c(-1,-4,-18)],1,function(x){x <- x/sum(x, na.rm = T); return(x)}))  #-4 -18 to get rid of "Animal" and "Egg" concepts
colnames(rel_trawls)[which(!(colnames(rel_trawls) %in% colnames(cast_broadiets)))] #CHECK EVERY TIME!
expanded_broadiets <- data.frame(cast_broadiets, Amphipod = rep(0, nrow(cast_broadiets)),Anthozoa = rep(0, nrow(cast_broadiets)),Barnacle = rep(0, nrow(cast_broadiets)),Brachiopod = rep(0, nrow(cast_broadiets)),Cephalopod = rep(0, nrow(cast_broadiets)),Chaetognath = rep(0, nrow(cast_broadiets)),Cladoceran = rep(0, nrow(cast_broadiets)),Cumacean = rep(0, nrow(cast_broadiets)),Doliolid = rep(0, nrow(cast_broadiets)),Echinoderm = rep(0, nrow(cast_broadiets)), Gastropod = rep(0, nrow(cast_broadiets)), Pyrosome = rep(0, nrow(cast_broadiets)),Siphonophore = rep(0, nrow(cast_broadiets)), Hydromedusa = rep(0, nrow(cast_broadiets)), Isopod = rep(0, nrow(cast_broadiets)), Polychaete = rep(0, nrow(cast_broadiets)), Phyllocarid = rep(0, nrow(cast_broadiets)))
expanded_broadiets <- expanded_broadiets[,match(colnames(rel_trawls), colnames(expanded_broadiets))]
rel_GC <- t(apply(expanded_broadiets,1,function(x){x <- x/sum(x); return(x)}))
selectivity <- as.data.frame(matrix(nrow=nrow(rel_trawls), ncol=ncol(rel_trawls)))
names(selectivity) <- colnames(rel_trawls); rownames(selectivity) <- rownames(rel_GC)
selectivity <- LI(rel_GC, rel_trawls,selectivity)
cast_broadiets$Species[which(cast_broadiets$Species=="Apolemia undescribed sp")] <- "Apolemia sp"
cast_broadiets$Species[which(cast_broadiets$Species=="Nanomia (deep)")] <- "Nanomia sp. deep"
selectivity <- data.frame(selectivity, Species = cast_broadiets$Species, Specimen = cast_broadiets$Specimen)
selectivity_melt <- melt(selectivity, id.vars = c("Specimen", "Species"))
names(selectivity_melt) <- c("Specimen","Species", "Prey", "L.I.")
selectivity_melt$Species <- as.character(selectivity_melt$Species)
selectivity_melt$Species <- factor(selectivity_melt$Species, levels=SPorder[which(SPorder %in% selectivity_melt$Species)])
IDorder <- unique(arrange(selectivity_melt, Species)$Specimen)
selectivity_melt$Specimen <- factor(selectivity_melt$Specimen, levels=IDorder)
selectivity_melt$Prey <- factor(selectivity_melt$Prey, levels=PreyOrderTr)
names(selectivity_melt)[3]<-"Selectivity"
selectivity_melt[,4] <- as.numeric(selectivity_melt[,4])
SEL <- ggplot(selectivity_melt, aes(x = Selectivity, y = Specimen, fill = `L.I.`)) + geom_tile() + scale_fill_gradient2(low = "red", high = "blue", mid = "white", na.value = "grey") + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.title.y=element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank())
SEL
selectivity_spp <- aggregate(selectivity_melt$L.I.~selectivity_melt$Selectivity+selectivity_melt$Species, FUN=function(x){mean(x,na.rm = T)})
names(selectivity_spp) <- c("Prey","Species","L.I.")
GCspecies_melt$Species[which(!(GCspecies_melt$Species %in% selectivity_spp$Species))] %>% unique() -> missing_spp
expand.grid(unique(selectivity_spp$Prey),missing_spp)->missing_entries
missing_entries <- cbind(missing_entries, rep(NA, nrow(missing_entries)))
names(missing_entries) <- names(selectivity_spp)
selectivity_spp <- rbind(selectivity_spp, missing_entries)
SEL_spp <- ggplot(selectivity_spp, aes(x = Prey, y = Species, fill = `L.I.`)) + geom_tile() + scale_fill_gradient2(low = "red", high = "blue", mid = "white", na.value = "grey") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.title.y=element_blank())
SEL_spp
getwd()
pdf("GC-Trawls-SEL.pdf", height = 10, width = 12)
wrap_plots(GC,TR,SEL, widths = c(1,1.7,1.7))
dev.off()
pdf("GC-SEL_spp.pdf", height = 10, width = 12)
wrap_plots(GC_spp,SEL_spp, widths = c(1,1.7))
dev.off()
cast_trawl[13,-1]
cast_trawl[,1]
trawl_to_specimen %>% unique() %>%  .[,3] %>% unique()
library(tidyverse)
library(reshape2)
library(scales)
library(RColorBrewer)
library(forcats)
library(vegan)
library(adegenet)
library(magrittr)
library(plyr)
library(paleotree)
library(phytools)
library(patchwork)
library(ggtree)
library(ggplotify)
library(scatterpie)
barcodes=c("134", "152","166", "179", "261", "272")
runids = c("RUN0","RUN1","RUN2","RUN3", "RUN4","RUN5")
### Analyze Metaxa & Trawl Data
#Read metabarcoding data
setwd("/Volumes/GoogleDrive/My Drive/Metabarcoding_things/")
allsamples <- read.csv("/Volumes/GoogleDrive/My Drive/Metabarcoding_things/siphweb_metabarcoding/AllSamplesParsed.tsv", sep="\t", header = T, stringsAsFactors = F)
allsamples <- allsamples[,-66]
#Parse sequences/feature_names
allseqs <- read.csv("/Volumes/GoogleDrive/My Drive/Metabarcoding_things/siphweb_metabarcoding/seqs-feats.csv", sep="\t", header = F, stringsAsFactors = F)
names(allseqs) <- c("Feature_name","Sequence")
allseqs <- allseqs[which(allseqs$Feature_name %in% unique(allsamples$Feature_name)),]
seqs_samples <- full_join(allsamples,allseqs, by="Feature_name")
#write.table(seqs_samples, "SequencesParsed.tsv", sep="\t", col.names = T, row.names = F)
#Read trawl data
trawls = read.csv("/Volumes/GoogleDrive/My\ Drive/Metabarcoding_things/siphweb_metabarcoding/trawls_data_Nov2020.tsv", header=T, sep="\t", stringsAsFactors = F)
trawls$Broad.group[which(trawls$Broad.group == "Krill")] <- "Euphausid"
trawls$Broad.group[which(trawls$Broad.group == "Gymnosome pteropod")] <- "Gastropod"
trawls$Broad.group[which(trawls$Broad.group == "Appendicularia")] <- "Larvacean"
trawls$Broad.group[which(trawls$Broad.group == "Appendicularian")] <- "Larvacean"
trawls$Broad.group[which(trawls$Broad.group == "Benthic snail")] <- "Gastropod"
trawls$Broad.group[which(trawls$Broad.group == "Copepod ")] <- "Copepod"
samples <- split(trawls, trawls$Sample)
#samples.bygroup <- lapply(samples, function(x){aggregate(x$Representative.count, by = list(x$Broad.group), FUN = sum)})
samples.bygroup <- lapply(samples, function(x){aggregate(x$Count, by = list(x$Broad.group), FUN = sum)})
for(i in 1:length(samples.bygroup)){
samples.bygroup[[i]] <- cbind(rep(names(samples.bygroup)[i], nrow(samples.bygroup[[i]])), samples.bygroup[[i]])
}
broad.taxa <- bind_rows(samples.bygroup)
names(broad.taxa) <- c("Sample", "Broad.group", "Representative.count")
broad.taxa$Representative.count[is.na(broad.taxa$Representative.count)]<-1
#Encode extraction-to-trawl match
ext <- read.csv("/Volumes/GoogleDrive/My Drive/Metabarcoding_things/siphweb_metabarcoding/extractions_GC_Nov2020.tsv", header=T, stringsAsFactors = F, sep="\t" )
trawl_to_specimen <- ext[,c(1,3,13)]
RUN0trawls = data.frame(Extraction..=allsamples$Extraction, Specimen.. = allsamples$Specimen, Corrresponding.prey.field.sample = rep(NA, nrow(allsamples)))[which(allsamples$run == "RUN0"),]
names(RUN0trawls) <- names(trawl_to_specimen)
trawl_to_specimen <- rbind(trawl_to_specimen, RUN0trawls)
dyads_by_specimen = list()
it=0
for(i in unique(allsamples$Specimen)){
dyad_i = list()
dyad_i[[1]] <- allsamples[which(allsamples$Specimen == i),]
tows <- trawl_to_specimen$Corresponding.prey.field.sample[which(trawl_to_specimen$Specimen.. == i)]
trawls_i <- trawls[which(trawls$Sample == tows),]
if(nrow(trawls_i)>0){dyad_i[[2]] <- trawls_i}
else dyad_i[[2]] <- NA
names(dyad_i)=c("Diet", "Preyfield")
it=it+1
dyads_by_specimen[[it]] <- dyad_i
names(dyads_by_specimen)[[it]] <- i
}
dyads_by_specimen$`BIOS19-D2-P1`$Preyfield[,c(2,3,4,7)]
dyads_by_specimen$`BIOS19-D2-P1`$Diet[,c(8:11,48)]
## FINAL FIGURE ###
#row by specimen - #broad GC group set of columns - #broad prey groups in trawl set of columns
#Widen format of GC data
diets_broad <- allsamples[which(allsamples$Interpretation == "Prey"),c("Specimen","Species","Broad.group")] %>% unique()
cast_broadiets <- dcast(diets_broad, Specimen + Species ~ Broad.group)
cast_broadiets[is.na(cast_broadiets)] <- 0
cast_broadiets[,c(3:ncol(cast_broadiets))] <- sapply(cast_broadiets[,c(3:ncol(cast_broadiets))], as.numeric)
cast_broadiets[is.na(cast_broadiets)] <- 1
#Widen format of trawl data
cast_trawl <- dcast(broad.taxa, Sample ~ Broad.group)
cast_trawl[is.na(cast_trawl)] <- 0
#Match trawlcast to specimen
trawlbyspecimen <- cast_trawl[match(trawl_to_specimen$Corresponding.prey.field.sample[match(cast_broadiets$Specimen, trawl_to_specimen$Specimen..)], cast_trawl$Sample),]
names(trawlbyspecimen)[1]<-"Trawl"
trawlbyspecimen <- data.frame(trawlbyspecimen, Phyllocarid = trawlbyspecimen$Stomatopod*0) #add phyllocarid zeroes
#Bind GC and trawls
GC_Trawl_broad <- cbind(cast_broadiets, trawlbyspecimen)
rownames(GC_Trawl_broad)<-GC_Trawl_broad$Specimen
GC_Trawl_broad$Species[which(GC_Trawl_broad$Species=="Apolemia undescribed sp")] <- "Apolemia sp"
GC_Trawl_broad$Species[which(GC_Trawl_broad$Species=="Nanomia (deep)")] <- "Nanomia sp. deep"
GC_Trawl_broad[,c("Cephalopod", "Cumacean")]
#Phylogeny of the species sampled
tree = read.newick(text="(Physalia physalis,((Apolemia sp,Apolemia rubriversa,Apolemia lanosa),((Bargmannia amoena,Bargmannia elongata,Bargmannia lata),(((Undescribed physonect L),(Resomia dunni,(Forskalia sp.,(Lychnagalma utricularia,(Halistemma rubrum,(Nanomia sp. Atlantic,Nanomia sp. shallow,Nanomia sp. deep)))))),(Vogtia serrata,(Desmophyes annectens,(Chuniphyes multidentata,((Sphaeronectes koellikeri,Sphaeronectes christiansonae),((Muggiaea atlantica,(Lensia conoidea,Sulculeolaria chuni)),Diphyes dispar)))))))))));")
### Analyze Metaxa & Trawl Data
#Read metabarcoding data
setwd("/Volumes/GoogleDrive/My Drive/Metabarcoding_things/")
getwd()
### Analyze Metaxa & Trawl Data
#Read metabarcoding data
setwd("smb://localhost/alejandro.damianserrano@yale.edu - Google Drive/My Drive/Metabarcoding_things/")
### Analyze Metaxa & Trawl Data
#Read metabarcoding data
setwd("/smb://localhost/alejandro.damianserrano@yale.edu - Google Drive/My Drive/Metabarcoding_things/")
install.packages("googledrive")
install.packages("googledrive")
library(googledrive)
library(tidyverse)
library(reshape2)
library(scales)
library(RColorBrewer)
library(forcats)
library(vegan)
library(adegenet)
library(magrittr)
library(plyr)
library(paleotree)
library(phytools)
library(patchwork)
library(ggtree)
library(ggplotify)
library(scatterpie)
drive_get(path="/My Drive/Metabarcoding_things")
drive_get(path="My Drive/Metabarcoding_things")
drive_get(path="My Drive/Metabarcoding_things")
drive_get(path="My Drive/Metabarcoding_things")
drive_deauth()
drive_get(path="My Drive/Metabarcoding_things")
library(tidyverse)
library(ape)
library(phytools)
library(reshape2)
library(data.table)
library(geiger)
library(corHMM)
setwd("~/Documents/salp_ecomorphology/")
traits <- read.csv("salplit.tsv", sep="\t", stringsAsFactors = F)
traits$Species[which(traits$Species == "Iasis (Weelia) cylindrica")] <- "Iasis cylindrica"
traits$Species[which(traits$Species == "Soestia (Iasis) zonaria")] <- "Soestia zonaria"
tree_salp <- read.nexus("phylogeny/RevBayes/TIMETREE_Chordata_output/TimeTree_chordata_mcmc_MAP.tre")
tree_salp$tip.label <- str_remove_all(tree_salp$tip.label, ".+\\..+?_")
tree_salp$tip.label <- str_replace_all(tree_salp$tip.label, "_", " ")
plot(tree_salp);tiplabels(cex=0.7)
plot(drop.tip(tree_salp, c(32:52)))
tree_salp <- drop.tip(tree_salp, c(32:52)) #drop outgroups
tiplabels(cex=0.7)
plot(drop.tip(tree_salp, c(1,2,6,9,14,16,18,19,20,22,23,27)))
tree_salp <- drop.tip(tree_salp, c(1,2,6,9,14,16,18,19,20,22,23,27)) #drop duplicate species
tree_salp$edge.length
tree_salp$edge.length <- 5*tree_salp$edge.length
plot(tree_salp)
tree_salp$edge.length <- 5*tree_salp$edge.length
plot(tree_salp)
tree_salp <- read.nexus("phylogeny/RevBayes/TIMETREE_Chordata_output/TimeTree_chordata_mcmc_MAP.tre")
tree_salp$tip.label <- str_remove_all(tree_salp$tip.label, ".+\\..+?_")
tree_salp$tip.label <- str_replace_all(tree_salp$tip.label, "_", " ")
tree_salp <- drop.tip(tree_salp, c(32:52)) #drop outgroups
tree_salp <- drop.tip(tree_salp, c(1,2,6,9,14,16,18,19,20,22,23,27))
plot(tree_salp)
tree_salp_pruned <- drop.tip(tree_salp, which(!(tree_salp$tip.label %in% unique(traits$Species))))
pruned_traits <- traits[which(traits$Species %in% tree_salp$tip.label),]
unique_traits <- unique(pruned_traits)
